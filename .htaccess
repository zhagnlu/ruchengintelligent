<IfModule mod_rewrite.c>
  RewriteEngine On
  
  # 排除CDN已缓存的WebP请求（关键修复）
  RewriteCond %{REQUEST_URI} !\.webp$ [NC]
    
  # 仅处理 JPG/JPEG/PNG 请求，且浏览器支持 WebP
  RewriteCond %{REQUEST_URI} \.(jpeg|jpg|png)$ [NC]
  RewriteCond %{HTTP_ACCEPT} image/webp [NC]
  RewriteCond %{REQUEST_FILENAME}.webp -f
  RewriteRule ^(.*)\.(jpeg|jpg|png)$ $1.webp [T=image/webp,L]
</IfModule>

<IfModule mod_headers.c>
  # 始终为图像添加 Vary: Accept 头（无论是否转换）
  <FilesMatch "\.(jpeg|jpg|png|webp)$">
    Header set Cache-Control "public, max-age=31536000"
    # 告知cdn 区分缓存版本
    Header append Vary Accept
  </FilesMatch>
</IfModule>

<IfModule mod_mime.c>
  AddType image/webp .webp
</IfModule>
